<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Factura - Citar√° Ferreter√≠a</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
    background:#d9d9d9;
    font-family: Arial, sans-serif;
}

#factura{
    width:900px;
    margin:30px auto;
    background:white;
    padding:20px;
    border:2px solid #1f3fa3;
}

h1{
    text-align:center;
    color:#1f3fa3;
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:20px;
}

th, td{
    border:1px solid #1f3fa3;
    padding:5px;
    text-align:center;
}

th{
    background:#cfd8f6;
}

input{
    width:100%;
    border:none;
    outline:none;
    text-align:center;
}

.totales{
    width:300px;
    float:right;
    margin-top:20px;
}

.totales td{
    border:1px solid #1f3fa3;
}

button{
    padding:8px 15px;
    background:#1f3fa3;
    color:white;
    border:none;
    cursor:pointer;
    margin-right:10px;
}

.no-print{
    margin-top:20px;
}

</style>
</head>
<body>

<div id="factura">

<h1>CITAR√Å FERRETER√çA</h1>
<p style="text-align:center;">NIT: 1.078.918.733-6<br>Quibd√≥, Choc√≥</p>

<table id="tablaProductos">
<thead>
<tr>
<th>CANT</th>
<th>DESCRIPCI√ìN</th>
<th>Vr. UNITARIO</th>
<th>Vr. TOTAL</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

<table class="totales">
<tr>
<td>SUBTOTAL</td>
<td id="subtotal">$0</td>
</tr>
<tr>
<td>IVA (19%)</td>
<td id="iva">$0</td>
</tr>
<tr>
<td><strong>TOTAL</strong></td>
<td id="total"><strong>$0</strong></td>
</tr>
</table>

<div class="no-print">
<button onclick="agregarFila()">Agregar Fila</button>
<button onclick="generarPDF()">Descargar PDF</button>
</div>

</div>

<script>

const tbody = document.querySelector("#tablaProductos tbody");

// üîπ Crear 18 filas iniciales
for(let i=0;i<18;i++){
    agregarFila();
}

function agregarFila(){
    const fila = document.createElement("tr");

    fila.innerHTML = `
    <td><input type="number" oninput="calcular(this)"></td>
    <td><input type="text"></td>
    <td><input type="number" oninput="calcular(this)"></td>
    <td><span class="totalProducto">0</span></td>
    `;

    tbody.appendChild(fila);
}

function calcular(input){
    const fila = input.closest("tr");
    const cantidad = fila.children[0].querySelector("input").value || 0;
    const precio = fila.children[2].querySelector("input").value || 0;

    const total = cantidad * precio;
    fila.children[3].querySelector(".totalProducto").innerText = total;

    recalcularTotales();
}

function recalcularTotales(){
    let subtotal = 0;
    document.querySelectorAll(".totalProducto").forEach(td=>{
        subtotal += parseFloat(td.innerText) || 0;
    });

    let iva = subtotal * 0.19;
    let total = subtotal + iva;

    document.getElementById("subtotal").innerText = "$" + subtotal.toLocaleString();
    document.getElementById("iva").innerText = "$" + iva.toLocaleString();
    document.getElementById("total").innerText = "$" + total.toLocaleString();
}

async function generarPDF(){

    const botones = document.querySelector(".no-print");
    botones.style.display = "none";

    const { jsPDF } = window.jspdf;
    const factura = document.getElementById("factura");

    const canvas = await html2canvas(factura);
    const imgData = canvas.toDataURL("image/png");

    const pdf = new jsPDF("p", "mm", "a4");
    const width = pdf.internal.pageSize.getWidth();
    const height = (canvas.height * width) / canvas.width;

    pdf.addImage(imgData, "PNG", 0, 5, width, height);
    pdf.save("factura.pdf");

    botones.style.display = "block";
}

</script>

</body>
</html>
