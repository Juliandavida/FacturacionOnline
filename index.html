<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Factura</title>

<style>
body {
	font-family: Arial, sans-serif;
	display: flex;
	justify-content: center;
	padding: 20px;
}

.factura {
	width: 850px;
	border: 2px solid #1c3faa;
	padding: 15px;
}

.header {
	display: flex;
	justify-content: space-between;
	border-bottom: 2px solid #1c3faa;
	padding-bottom: 10px;
}

.titulo {
	text-align: center;
	flex: 1;
}

.titulo h1 {
	margin: 0;
	color: #1c3faa;
}

.tipo-doc {
	width: 180px;
	text-align: left;
}

.tipo-doc label {
	display: block;
	margin-bottom: 5px;
}

.numero {
	color: red;
	font-weight: bold;
	margin-top: 5px;
}

.numero input {
	width: 70px;
	border: none;
	border-bottom: 1px solid red;
	color: red;
	font-weight: bold;
	text-align: center;
}

.info {
	display: flex;
	justify-content: space-between;
	margin-top: 15px;
}

.campo {
	margin-bottom: 8px;
}

.campo label {
	display: inline-block;
	width: 110px;
	font-weight: bold;
}

.campo input {
	border: none;
	border-bottom: 1px solid black;
	width: 200px;
}

table {
	width: 100%;
	border-collapse: collapse;
	margin-top: 20px;
}

th, td {
	border: 1px solid #1c3faa;
	padding: 5px;
	text-align: center;
	font-size: 13px;
}

th {
	background: #dbe5ff;
}

tbody tr:nth-child(even) {
	background: #eef3ff;
}

input.producto {
	width: 95%;
	border: none;
	text-align: center;
}

.vacio input {
	color: transparent;
}

.vacio span {
	visibility: hidden;
}

.totales {
	width: 300px;
	float: right;
	margin-top: 20px;
}

.totales td {
	border: 1px solid #1c3faa;
}

button {
	margin-top: 30px;
	padding: 10px 20px;
	background: #1c3faa;
	color: white;
	border: none;
	cursor: pointer;
	margin-right: 10px;
}

@media print {
	.no-print {
		display: none;
	}
}
</style>
</head>

<body>

<div class="factura" id="factura">

<div class="header">

<div style="width:150px; display:flex; align-items:center;">
<img src="logo.png" style="height:120px;">

</div>

<div class="titulo">
<h1>CITAR FERRETERA</h1>
<p>NIT: 1.078.918.733-6</p>
<p>La Cascorba diagonal al Guaje - Quibd贸, Choc贸</p>
</div>

<div class="tipo-doc">
<label><input type="checkbox"> Cotizaci贸n</label>
<label><input type="checkbox"> Remisi贸n</label>
<div class="numero">
No. <input type="number" value="0">
</div>
</div>

</div>

<div class="info">

<div>
<div class="campo">
<label>Cotizado a:</label>
<input type="text">
</div>

<div class="campo">
<label>Direcci贸n:</label>
<input type="text">
</div>
</div>

<div>
<div class="campo">
<label>Fecha:</label>
<input type="date">
</div>

<div class="campo">
<label>C.C. 贸 NIT:</label>
<input type="text">
</div>
</div>

</div>

<table>
<thead>
<tr>
<th style="width:10%;">CANT</th>
<th style="width:50%;">DESCRIPCIN</th>
<th style="width:20%;">Vr. UNITARIO</th>
<th style="width:20%;">Vr. TOTAL</th>
</tr>
</thead>
<tbody id="tablaProductos"></tbody>
</table>

<table class="totales">
<tr>
<td>SUBTOTAL</td>
<td>$<span id="subtotal"></span></td>
</tr>

<tr id="filaIVA">
<td>
IVA (<input type="number" id="ivaInput" value="19"
style="width:50px;border:none;border-bottom:1px solid black;text-align:center;"
oninput="recalcularTotales()">%)
</td>
<td>$<span id="iva"></span></td>
</tr>

<tr>
<td><strong>TOTAL</strong></td>
<td><strong>$<span id="totalFinal"></span></strong></td>
</tr>
</table>

<div class="no-print">
<button onclick="agregarFila()">Agregar Fila</button>
<button onclick="generarPDF()">Descargar PDF</button>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>

let tabla = document.getElementById("tablaProductos");

// 18 filas iniciales
for (let i = 0; i < 18; i++) {
	agregarFila();
}

function agregarFila() {
	tabla.innerHTML += `
	<tr class="vacio">
		<td><input type="number" class="producto cantidad" oninput="calcular(this)"></td>
		<td><input type="text" class="producto descripcion" oninput="calcular(this)"></td>
		<td><input type="number" class="producto precio" oninput="calcular(this)"></td>
		<td><span class="totalProducto"></span></td>
	</tr>`;
}

function calcular(input) {

	let fila = input.closest("tr");
	let cantidad = parseFloat(fila.querySelector(".cantidad").value) || 0;
	let precio = parseFloat(fila.querySelector(".precio").value) || 0;
	let descripcion = fila.querySelector(".descripcion").value;

	let total = cantidad * precio;
	fila.querySelector(".totalProducto").innerText = total > 0 ? total : "";

	if (cantidad == 0 && precio == 0 && descripcion == "") {
		fila.classList.add("vacio");
	} else {
		fila.classList.remove("vacio");
	}

	recalcularTotales();
}

function recalcularTotales() {

	let cantidades = document.querySelectorAll(".cantidad");
	let precios = document.querySelectorAll(".precio");

	let subtotal = 0;

	for (let i = 0; i < cantidades.length; i++) {
		subtotal += (parseFloat(cantidades[i].value) || 0) *
			(parseFloat(precios[i].value) || 0);
	}

	let subtotalSpan = document.getElementById("subtotal");
	let ivaSpan = document.getElementById("iva");
	let totalSpan = document.getElementById("totalFinal");
	let ivaInput = document.getElementById("ivaInput");
	let filaIVA = document.getElementById("filaIVA");

	if (subtotal == 0) {
		subtotalSpan.innerText = "";
		ivaSpan.innerText = "";
		totalSpan.innerText = "";
		filaIVA.style.display = "none";
		return;
	}

	subtotalSpan.innerText = subtotal;

	let porcentaje = parseFloat(ivaInput.value) || 0;

	if (porcentaje > 0) {
		let iva = subtotal * (porcentaje / 100);
		ivaSpan.innerText = iva.toFixed(0);
		filaIVA.style.display = "";
		totalSpan.innerText = (subtotal + iva).toFixed(0);
	} else {
		ivaSpan.innerText = "";
		filaIVA.style.display = "none";
		totalSpan.innerText = subtotal.toFixed(0);
	}
}

async function generarPDF() {

    const factura = document.getElementById("factura");
    const botones = document.querySelector(".no-print");

    //  Ocultar botones antes de generar PDF
    botones.style.display = "none";

    // Esperar que las im谩genes carguen
    const images = factura.getElementsByTagName("img");
    for (let img of images) {
        if (!img.complete) {
            await new Promise(resolve => {
                img.onload = resolve;
                img.onerror = resolve;
            });
        }
    }

    const canvas = await html2canvas(factura, {
        scale: 2
    });

    const imgData = canvas.toDataURL("image/png");
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");

    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

    pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
    pdf.save("factura.pdf");

    //  Volver a mostrar botones despu茅s
    botones.style.display = "block";
}



</script>

</body>
</html>
